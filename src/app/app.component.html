<div id="notification" class="popup-notification hidden"></div>
<div class="container-fluid d-flex bg-white shadow align-items-center justify-content-between rounded-bottom-2">
  <h2 class="ms-3">Angular Forms</h2>
  <div class="d-flex p-3 gap-3 justify-content-end">
    <button type="button" class="btn border-0" *ngIf="formHeading && savedFormNames.length != 0" data-bs-toggle="modal" data-bs-target="#formModal" appTooltip title="Add new field"><i class="fa-regular fa-square-plus"></i></button>
    <button type="button" class="btn border-0" *ngIf="showForm && savedFormNames.length != 0" (click)="openEditFormNameModal(formHeading)" data-bs-toggle="modal" data-bs-target="#editFormNameModal" appTooltip title="Edit form"><i class="fa-solid fa-file-code"></i></button>
    <button type="button" class="btn border-0" *ngIf="showForm && savedFormNames.length != 0" (click)="closeForm()" appTooltip title="Close form"><i class="fa-solid fa-file-excel"></i></button>
    <button type="button" class="btn border-0" *ngIf="savedFormNames.length > 0" data-bs-toggle="modal" data-bs-target="#savedFormsModal" appTooltip title="Open saved form"><i class="fa-solid fa-file"></i></button>
    <button type="button" class="btn border-0" (click)="createNewForm()" appTooltip title="Create new form"><i class="fa-solid fa-file-circle-plus"></i></button>
  </div>
</div>  

<div class="d-flex gap-5">
  <div class="position-absolute start-0 bottom-0 bg-white shadow w-25 rounded-end-5 rounded-bottom-0"
      style="flex: 1; height: 85vh; max-height: 85vh; overflow-y: auto; scrollbar-width: none;">
    <div class="container p-3" *ngIf="modalStep() === 'select' && fields.length != 0">
      <h3>Form Tree</h3>
      <ul class="tree-list">
        <li>
          <!-- Parent Div -->
          <div class="tree-node d-flex align-items-center" (click)="toggle('parent')">
            <span class="tag">div</span>

            <!-- Action buttons -->
            <button type="button" class="btn btn-sm border-0" data-bs-toggle="modal" data-bs-target="#formModal" appTooltip title="Add new field" (click)="$event.stopPropagation(); ">
              <i class="fa-regular fa-square-plus"></i>
            </button>
            <button type="button" class="btn btn-sm border-0" (click)="$event.stopPropagation(); toggleAllFieldsModal()" data-bs-toggle="modal" data-bs-target="#allFieldsModal" appTooltip title="Edit all fields">
              <i class='fas fa-edit'></i>
            </button>
            <button type="button" class="btn btn-sm border-0" appTooltip title="Delete all fields" (click)="$event.stopPropagation(); deleteAllFields()">
              <i class="fa-solid fa-trash-can"></i>
            </button>

            <!-- Caret -->
            <i class="fa" [ngClass]="expanded['parent'] ? 'fa-caret-down' : 'fa-caret-right'"></i>
          </div>

          <!-- Child divs each containing one input -->
          <ul *ngIf="expanded['parent']" class="ul tree-children"
              cdkDropList 
              [cdkDropListData]="fields" 
              (cdkDropListDropped)="drop($event)">
            
            <li *ngFor="let field of fields; let i = index" cdkDrag>
              <!-- Child div -->
              <div class="tree-node d-flex align-items-center" (click)="toggle('child-' + i)">
                <span class="tag">div</span>
                <button type="button" class="btn btn-sm border-0" 
                        (click)="$event.stopPropagation(); openEditFieldModal(i)" 
                        data-bs-toggle="modal" data-bs-target="#editFieldModal" 
                        appTooltip title="Edit field">
                  <i class='fas fa-edit'></i>
                </button>
                <button type="button" class="btn btn-sm border-0" 
                        appTooltip title="Delete field" 
                        (click)="$event.stopPropagation(); deleteField(i)">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
                <i class="fa" [ngClass]="expanded['child-' + i] ? 'fa-caret-down' : 'fa-caret-right'"></i>
              </div>

              <!-- Input inside child div -->
              <ul *ngIf="expanded['child-' + i]" class="ul tree-children">
                <li>
                  <div class="tree-node">
                    {{ field.type || 'input' }}: {{ field.props?.label || '...' }}
                  </div>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <div class="container position-absolute bottom-0 end-0 w-75">
    <div class="d-flex flex-column gap-2 p-4 bg-white rounded-top-5 shadow" style="flex: 1; height: 85vh; max-height: 85vh; overflow-y: auto; scrollbar-width: none;">
      <div *ngIf="formHeading">
        <div class="d-flex justify-content-between" (contextmenu)="showFormContextMenu($event)" #inputField>
          <h1>{{ formHeading }}</h1>
          <button type="button" class="btn border-0" *ngIf="formChanged" (click)="saveForm()" appTooltip title="Save form" style="font-size: 26px;"><i class="fa-solid fa-floppy-disk"></i></button>
        </div>
        <form [formGroup]="form" (ngSubmit)="onSubmit(model)" class="mt-3">
        <formly-form [model]="model" [fields]="fields" [form]="form" cdkDropList (cdkDropListDropped)="drop($event)"></formly-form>
          <div class="d-flex justify-content-center" *ngIf="!isEdit()" (contextmenu)="showFormContextMenu($event)" #inputField>
            <button type="submit" class="btn btn-primary mt-3" *ngIf="fields.length != 0">Submit</button>
            <p *ngIf="fields.length === 0"><em>Start adding fields...</em></p>
          </div>
          <div class="d-flex justify-content-center gap-3" *ngIf="isEdit()">
            <button type="button" class="btn btn-warning" (click)="update(model)" [disabled]="!form.valid">Update</button>
            <button type="button" class="btn border" (click)="cancel()">Cancel</button>
          </div>
        </form>
        <div class="table-responsive mt-3" (contextmenu)="showFormContextMenu($event)" #inputField>
          <table class="table table-bordered">
            <thead *ngIf="users.length != 0">
              <tr>
                <th>UID</th>
                <th *ngFor="let f of displayFields">{{ f.label }}</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="users.length === 0">
                <td [attr.colspan]="displayFields.length + 2" class="text-center">No users found.</td>
              </tr>
              <tr *ngFor="let user of users">
                <td>{{ user.id }}</td>
                <td *ngFor="let f of displayFields">
                  {{ getValue(user, f.key) }}
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <button class="btn border-0" (click)="editUser(user.id)"><i class='fas fa-edit'></i></button>
                    <button class="btn border-0" (click)="deleteUser(user.id)"><i class="fa-solid fa-trash-can"></i></button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="formModalLabel">Choose Field Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" (click)="cancelFieldModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row justify-content-center">
          <div class="col-3">
            <button type="button" class="btn btn-outline-primary w-100 p-5" data-bs-dismiss="modal" (click)="addFixedField('input')">Input</button>
          </div>
          <div class="col-3">
            <button type="button" class="btn btn-outline-secondary w-100 p-5" data-bs-dismiss="modal" (click)="addFixedField('textarea')">Textarea</button>
          </div>
          <div class="col-3">
            <button type="button" class="btn btn-outline-success w-100 p-5" data-bs-dismiss="modal" (click)="addFixedField('select')">Select</button>
          </div>
          <div class="col-3">
            <button type="button" class="btn btn-outline-warning w-100 p-5" data-bs-dismiss="modal" (click)="addFixedField('radio')">Radio</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Edit Form Name Modal -->
<div class="modal fade" id="editFormNameModal" tabindex="-1" aria-labelledby="editFormNameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal header -->
      <div class="modal-header">
        <h5 class="modal-title" id="editFormNameModalLabel">Edit Form</h5>
        <button type="button" class="btn-close border-0" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        <form [formGroup]="editFormModal" class="p-4 container" (ngSubmit)="saveFormNameChange()">
          <formly-form [model]="editFormModel" [fields]="editFormFields" [form]="editFormModal"></formly-form>
          <div class="d-flex mt-3 gap-2">
            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Save</button>
            <button type="button" class="btn btn-danger" (click)="deleteFormName()" data-bs-dismiss="modal">Delete Form</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="savedFormsModal" tabindex="-1" aria-labelledby="savedFormsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="savedFormsModalLabel">Saved Forms</h5>
        <button type="button" class="btn-close border-0" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="mb-3">Saved Forms</h5>
        <ul class="list-group">
          <li *ngFor="let formName of savedFormNames" 
              class="list-group-item d-flex justify-content-between align-items-center"
              style="cursor: pointer;"
              data-bs-dismiss="modal"
              (click)="loadSavedForm(formName)"
              (contextmenu)="showContextMenu($event, formName)"
              #inputField
              >
            {{ formName }}
            <button type="button" 
                    class="btn border-0" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editFormNameModal"
                    (click)="openEditFormNameModal(formName); $event.stopPropagation()">
              <i class='fas fa-edit'></i>
            </button>
          </li>
          <li *ngIf="savedFormNames.length === 0" class="list-group-item text-muted">
            No saved forms found.
          </li>
        </ul>
        <div class="d-flex justify-content-center">
          <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal" (click)="createNewForm()">Create New Form</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- EDIT FIELD MODAL -->
<div class="modal fade" id="editFieldModal" tabindex="-1" aria-labelledby="editFieldModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="editFieldModalLabel">Edit Field</h5>
        <button type="button" class="btn-close border-0" data-bs-dismiss="modal" aria-label="Close"
                (click)="cancelFieldModal()"></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="modalForm" (ngSubmit)="saveFieldEdit()" class="container">
          <formly-form [form]="modalForm" [fields]="modalFields" [model]="modalModel"></formly-form>
          
          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary me-2" data-bs-dismiss="modal">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelFieldModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Context Menu -->
<div *ngIf="formMenuVisible" class="custom-menu" [ngStyle]="{ top: menuPosition.y + 'px', left: menuPosition.x + 'px' }">
  <ul class="list-group">
    <li class="list-group-item" (click)="onMenuClick('loadSavedForm')" data-bs-toggle="modal" data-bs-target="#formModal">Add Field</li>
    <li class="list-group-item" (click)="openEditFormNameModal(formHeading)" data-bs-toggle="modal" data-bs-target="#editFormNameModal">Edit Form</li>
    <li class="list-group-item" (click)="closeForm()">Close Form</li>
  </ul>
</div>
<div *ngIf="editMenuVisible" class="custom-menu" [ngStyle]="{ top: menuPosition.y + 'px', left: menuPosition.x + 'px' }">
  <ul class="list-group">
    <li class="list-group-item" (click)="onMenuClick('openEditFieldModal')" data-bs-toggle="modal" data-bs-target="#editFieldModal">Edit Field</li>
    <li class="list-group-item" (click)="onMenuClick('deleteField')">Delete Field</li>
  </ul>
</div>
<div *ngIf="menuVisible" tabindex="3" class="custom-menu" [ngStyle]="{ top: menuPosition.y + 'px', left: menuPosition.x + 'px' }">
  <ul class="list-group">
    <li class="list-group-item" (click)="onMenuClick('openEditFormNameModal')" data-bs-toggle="modal" data-bs-target="#editFormNameModal">Edit Form</li>
    <li class="list-group-item" (click)="onMenuClick('deleteFormName')">Delete Form</li>
  </ul>
</div>
<!-- All Fields Modal -->
<div class="modal fade" id="allFieldsModal" tabindex="-1" aria-labelledby="allFieldsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="allFieldsModalLabel">Edit All Fields</h5>
        <button type="button" class="btn-close border-0" data-bs-dismiss="modal" aria-label="Close"
                (click)="toggleAllFieldsModal()"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form [formGroup]="allFieldsForm" (ngSubmit)="saveAllFieldsEdit()" class="container">
          <formly-form [form]="allFieldsForm" [model]="allFieldsModel" [fields]="allFieldsFields"></formly-form>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="submit" class="btn btn-success" data-bs-dismiss="modal" (click)="saveAllFieldsEdit()">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="toggleAllFieldsModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>
